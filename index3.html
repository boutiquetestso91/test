<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enregistreur Audio & GitHub Uploader</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; line-height: 1.6; background-color: #f4f4f9; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, button { display: block; width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-record { background-color: #e74c3c; color: white; }
        .btn-stop { background-color: #2c3e50; color: white; }
        .btn-download { background-color: #27ae60; color: white; }
        .btn-github { background-color: #4078c0; color: white; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #status { font-weight: bold; color: #2980b9; }
    </style>
</head>
<body>

    <h1>üéô Audio Recorder & GitHub</h1>

    <!-- SECTION 1 & 2 : Nom du fichier et Enregistreur -->
    <div class="section">
        <label for="fileName">1) Nom du fichier (ex: mon-audio.wav) :</label>
        <input type="text" id="fileName" placeholder="nom-du-fichier.wav" value="enregistrement.wav">

        <p>Statut : <span id="status">Pr√™t</span></p>
        <button id="startBtn" class="btn-record">D√©marrer l'enregistrement</button>
        <button id="stopBtn" class="btn-stop" disabled>Arr√™ter l'enregistrement</button>
        <audio id="audioPlayback" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
    </div>

    <!-- SECTION 3 : T√©l√©chargement -->
    <div class="section">
        <label>2) T√©l√©charger localement :</label>
        <button id="downloadBtn" class="btn-download" disabled>T√©l√©charger le fichier .wav</button>
    </div>

    <!-- SECTION 4 : Upload GitHub -->
    <div class="section">
        <label>3) Envoyer vers GitHub :</label>
        <input type="password" id="ghToken" placeholder="Entrez votre GitHub Personal Access Token (PAT)">
        <p style="font-size: 0.8em; color: #666;">Repo cible : boutiquetestso91/test</p>
        <button id="uploadBtn" class="btn-github" disabled>Uploader vers le repository</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileNameInput = document.getElementById('fileName');
        const status = document.getElementById('status');
        const audioPlayback = document.getElementById('audioPlayback');

        // Initialisation de l'enregistrement
        startBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayback.src = audioUrl;
                audioPlayback.style.display = 'block';
                downloadBtn.disabled = false;
                uploadBtn.disabled = false;
                status.innerText = "Enregistrement termin√©";
            };

            mediaRecorder.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "Enregistrement en cours...";
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        // T√©l√©chargement local
        downloadBtn.onclick = () => {
            let name = fileNameInput.value || 'enregistrement.wav';
            if (!name.endsWith('.wav')) name += '.wav';
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(audioBlob);
            link.download = name;
            link.click();
        };

        // Upload vers GitHub
        uploadBtn.onclick = async () => {
            const token = document.getElementById('ghToken').value;
            let name = fileNameInput.value || 'enregistrement.wav';
            if (!name.endsWith('.wav')) name += '.wav';

            if (!token) {
                alert("Veuillez renseigner votre token GitHub.");
                return;
            }

            status.innerText = "Upload vers GitHub en cours...";
            uploadBtn.disabled = true;

            // Conversion du blob en base64 pour l'API GitHub
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64data = reader.result.split(',')[1];
                
                // Configuration de l'API GitHub
                // Note : On utilise l'API de contenu (contents)
                const repo = "boutiquetestso91/test";
                const url = `https://api.github.com/repos/${repo}/contents/${name}`;

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Ajout de l'enregistrement audio : ${name}`,
                            content: base64data
                        })
                    });

                    if (response.ok) {
                        status.innerText = "‚úÖ Succ√®s ! Fichier envoy√© sur GitHub.";
                        alert("Fichier envoy√© avec succ√®s !");
                    } else {
                        const error = await response.json();
                        status.innerText = "‚ùå Erreur lors de l'envoi.";
                        alert("Erreur GitHub : " + error.message);
                    }
                } catch (err) {
                    status.innerText = "‚ùå Erreur de connexion.";
                    console.error(err);
                } finally {
                    uploadBtn.disabled = false;
                }
            };
        };
    </script>
</body>
</html>